
import { ifft } from "..";
import { MidiClip, NoteEvent } from "../clips/MidiClip";
import { EffectPlugin } from "../effects/effect_interface";
import { UseList_Heap } from "../performance/allocators/free_list";
import { LiveStruct, struct } from "../performance/allocators/structs";
import { generateWavetables } from "./gensquares";
import { sqpo } from "./osc/sqp";
import { PolyBLEPSquare } from "./pbs";
import { AOPluginType, AudioOutputPlugin } from "./plugin_interface";




// interface OscillatorTemplate {
//     wavetables: Record<number,Float32Array>,
//     getSample(phase: number, freq: number): { sample: number, new_phase: number };
// }
type OscillatorTemplate = any;

const Voice = struct({
    pitch: 'u8',
    velocity: 'u8',
    startTime: 'u32',
    done: 'bool',
    instance: 'u32',
    oscillatorPtr: 'u16',
    modulatorsPtr: 'u16',
    freq: 'f32',
    phase: 'f32',

    // ðŸ”½ ADD THESE
    lpf_z1: 'f32',     // filter memory
});


interface _VoiceInterface {
    pitch: number;
    velocity: number;
    startTime: number;
    done: boolean;
    instance: number;
    oscillatorPtr: number;
    modulatorsPtr: number;
    freq: number;
    phase: number;
    lpf_z1: number;
}




// const sqpo = {
//     wavetables: [
//         new Float32Array(2048).map((_, i, arr) => (i < arr.length / 2 ? 1 : -1))
//     ],
//     getSample(phase: number, freq: number) {
//         const table = this.wavetables[0];
//         const len = table.length;
//         const index = phase * len;
//         const i1 = Math.floor(index);
//         const frac = index - i1;

//         // wrap indices safely
//         const i0 = (i1 - 1 + len) % len;
//         const i2 = i1;
//         const i3 = (i1 + 1) % len;
//         const i4 = (i1 + 2) % len;

//         // cubic Hermite interpolation
//         const y0 = table[i0], y1 = table[i2], y2 = table[i3], y3 = table[i4];
//         const c0 = y1;
//         const c1 = 0.5 * (y2 - y0);
//         const c2 = y0 - 2.5 * y1 + 2 * y2 - 0.5 * y3;
//         const c3 = -0.5 * y0 + 1.5 * y1 - 1.5 * y2 + 0.5 * y3;

//         const sample = ((c3 * frac + c2) * frac + c1) * frac + c0;

//         // advance phase externally
//         const newPhase = phase + freq / 44100;
//         const wrappedPhase = newPhase >= 1 ? newPhase - 1 : newPhase;

//         return { sample, new_phase: wrappedPhase };
//     }

// }

// Define the square oscillator with linear interpolation

//On wavetable load, use FFT, discard all > nyquist, then ifft once, but test other options
// top-level filter state
// let lpf_z1 = 0;
// let lpf_alpha = 0.05;

// // top-level function
// function postMixLPF(sum: number): number {
//     lpf_z1 += lpf_alpha * (sum - lpf_z1);
//     return lpf_z1;
// }

// const wats = await generateWavetables();
// const x = new Float32Array([
//     0.01986919477425346, 0.05957174915531411, 0.09916691408769845, 0.1385834830047953, 0.17775082737828016, 0.21659912481919363, 0.25505958408039897, 0.2930646660973406, 0.33054830022055387, 0.36744609481346335, 0.40369554141250125, 0.43923621167343607, 0.47400994635785854, 0.507961035646939, 0.5410363901056445, 0.5731857016595083, 0.6043615939875243, 0.6345197617786839, 0.6636190983458095, 0.6916218111385978, 0.7184935247477889, 0.74420337104405, 0.7687240661481847, 0.7920319739835032, 0.814107156216285, 0.8349334084460781, 0.8544982825638143, 0.8727930952521775, 0.8898129226590327, 0.9055565813308666, 0.9200265955487187, 0.9332291512639439, 0.9451740368849283, 0.9558745712184443, 0.9653475189204817, 0.9736129938608119, 0.9806943508531243, 0.9866180662480454, 0.991413607929577, 0.9951132952962286, 0.9977521498462925, 0.9993677370220283, 0.9999999999999997, 0.999691086144189, 0.9984851668647056, 0.996428251647903, 0.9935679970432674, 0.9899535114086145, 0.9856351562278169, 0.9806643448243998, 0.9750933392999431, 0.9689750465282608, 0.9623628140347524, 0.9553102265853018, 0.947870904300463, 0.9400983030987051, 0.9320455182570516, 0.9237650918587658, 0.9153088248758431, 0.9067275946090867, 0.8980711781805798, 0.88938808274263, 0.8807253830337768, 0.8721285668765006, 0.8636413891729803, 0.8553057349147265, 0.8471614916795073, 0.8392464320447375, 0.8315961063006972, 0.824243745799795, 0.817220177229777, 0.8105537480495529, 0.8042702632763782, 0.7983929337627172, 0.7929423360504609, 0.7879363838394882, 0.7833903110570756, 0.7793166664646222, 0.7757253196887389, 0.7726234785152156, 0.7700157172369191, 0.7679040158004835, 0.766287809451949, 0.7651640485384814, 0.7645272680821142, 0.7643696667022989, 0.7646811944270949, 0.7654496488981951, 0.7666607794428456, 0.7682983984561859, 0.7703444995107271, 0.7727793815857142, 0.7755817787880517, 0.7787289949184267, 0.7821970422212233, 0.7859607836449524, 0.7899940779311203, 0.7942699268438652, 0.7987606238502081, 0.8034379035614722, 0.808273091250212, 0.8132372517638824, 0.8183013371664024, 0.8234363324516246, 0.8286133986884817, 0.8338040129761203, 0.8389801046085416, 0.844114186872063, 0.8491794839251169, 0.8541500522384309, 0.859000896104271, 0.8637080767561053, 0.8682488146744919, 0.8726015846911392, 0.8767462035406617, 0.8806639095484435, 0.8843374341829919, 0.8877510652420263, 0.890890701483131, 0.8937438985518784, 0.8962999061027013, 0.8985496960502773, 0.9004859819315912, 0.9021032294009017, 0.9033976579214714, 0.9043672337588248, 0.9050116544203438, 0.9053323247250316, 0.9053323247250312, 0.9050163697368904, 0.9043907627753635, 0.9034633397156902, 0.9022434075415408, 0.9007416760651076, 0.8989701835330045, 0.8969422165565908, 0.894672224827969, 0.8921757311031455, 0.8894692369515589, 0.8865701247863975, 0.8834965567026783, 0.8802673706600219, 0.8769019745543024, 0.8734202387269532, 0.869842387462582, 0.8661888900247967, 0.8624803517766882, 0.8587374059264041, 0.8549806064296316, 0.8512303225697151, 0.8475066357226024, 0.8438292387979558, 0.8402173388296313, 0.8366895631684885, 0.8332638697081958, 0.8299574615505101, 0.8267867064905583, 0.8237670616750431, 0.82091300375723, 0.8182379648421644, 0.8157542744839834, 0.8134731079646033, 0.8114044410496216, 0.8095570113831804, 0.8079382866489091, 0.806554439589154, 0.8054103299395806, 0.8045094933011935, 0.8038541369369012, 0.8034451424452677, 0.8032820752300566, 0.8033632006509032, 0.8036855067079596, 0.8042447330819315, 0.8050354063205906, 0.8060508809338499, 0.8072833861318905, 0.808724077914778, 0.8103630961976419, 0.8121896266328777, 0.8141919667701207, 0.8163575961759483, 0.8186732501185761, 0.821124996408171, 0.8236983149709713, 0.8263781797251631, 0.8291491423184756, 0.8319954172817399, 0.8349009681492175, 0.8378495940953614, 0.8408250166387868, 0.8438109659676098, 0.846791266445892, 0.849749920868714, 0.8526711930432627, 0.8555396882852888, 0.8583404314341887, 0.8610589420058098, 0.863681306119692, 0.8661942448568067, 0.8685851787247663, 0.8708422879299088, 0.8729545681794152, 0.8749118817616166, 0.8767050036787425, 0.8783256626334071, 0.8797665766979881, 0.8810214835245826, 0.8820851649822682, 0.8829534661378236, 0.8836233085256723, 0.8840926976825492, 0.8843607249519758, 0.8844275635930361, 0.8842944592569396, 0.8839637149233474, 0.8834386704162518, 0.8827236766462175, 0.8818240647518726, 0.8807461103385694, 0.8794969930359754, 0.8780847516189049, 0.8765182349568605, 0.8748070490774048, 0.8729615006465504, 0.8709925371857554, 0.8689116843597539, 0.8667309806823146, 0.8644629099979858, 0.8621203321069749, 0.8597164119074414, 0.8572645474346585, 0.8547782971796817, 0.8522713070713784, 0.8497572375048933, 0.8472496907968923, 0.8447621394432511, 0.8423078555482844, 0.83989984178617, 0.8375507642449911, 0.8352728874918383, 0.8330780121837634, 0.8309774155341445, 0.8289817949272638, 0.8271012149557694, 0.8253450581362143, 0.8237219795372125, 0.8222398655330037, 0.8209057968724903, 0.8197260162302512, 0.818705900381731, 0.8178499371199243, 0.817161707005518, 0.8166438700167747, 0.8162981571395505, 0.816125366911909, 0.8161253669119088, 0.8162971001514748, 0.8166385963139234, 0.8171469877478436, 0.8178185301057385, 0.8186486274922655, 0.8196318619641545, 0.8207620272020839, 0.8220321661540259, 0.8234346124299665, 0.8249610352095391, 0.8266024874070753, 0.8283494568229659, 0.8301919199960821, 0.8321193984594475, 0.8341210170903743, 0.8361855642369689, 0.8383015532953217, 0.8404572854057979, 0.8426409129327382, 0.8448405033895144, 0.847044103470295, 0.849239802851044, 0.8514157974252156, 0.8535604516442331, 0.8556623596392068, 0.8577104048083161, 0.8596938175639028, 0.861602230944455, 0.8634257338092871, 0.8651549213477686, 0.8667809426503151, 0.868295545104964, 0.869691115401138, 0.8709607169410013, 0.872098123478603, 0.8730978488276252, 0.8739551724998973, 0.8746661611588407, 0.8752276857944683, 0.8756374345494649, 0.8758939211489815, 0.8759964889100915, 0.875945310330137, 0.8757413822764172, 0.8753865168226599, 0.8748833278003637, 0.8742352131553075, 0.8734463332211552, 0.872521585043038, 0.8714665729041805, 0.8702875752279143, 0.868991508045742, 0.8675858852393488, 0.8660787757805283, 0.8644787582078416, 0.8627948725923511, 0.8610365702569288, 0.8592136615243627, 0.8573362617787265, 0.8554147361321828, 0.8534596429955605, 0.8514816768555977, 0.8494916105647164, 0.8475002374505474, 0.8455183135521501, 0.8435565002880127, 0.8416253078574532, 0.839735039672005, 0.8378957381068223, 0.8361171318540641, 0.8344085851507188, 0.8327790491424255, 0.8312370156326137, 0.8297904734527913, 0.8284468676751247, 0.8272130618726614, 0.8260953036157387, 0.8250991933753739, 0.8242296569858668, 0.823490921799518, 0.8228864966464491, 0.8224191556920292, 0.8220909262635403, 0.821903080696535, 0.8218561322299494, 0.8219498349575888, 0.8221831878221724, 0.8225544426168383, 0.8230611159379883, 0.8237000050126768, 0.824467207303569, 0.8253581437748629, 0.8263675856836283, 0.8274896847428507, 0.8287180064851585, 0.8300455666398596, 0.8314648703206032, 0.8329679538067718, 0.8345464286887003, 0.8361915281350406, 0.8378941550301335, 0.8396449317201428, 0.8414342510990019, 0.8432523287589628, 0.8450892559257314, 0.8469350528948678, 0.8487797226843148, 0.8506133046176185, 0.8524259275535953, 0.8542078624808989, 0.8559495742001036, 0.8576417718215291, 0.8592754578140758, 0.8608419753487271, 0.8623330536901226, 0.863740851400599, 0.8650579971333161, 0.8662776278044456, 0.8673934239488242, 0.8683996420789063, 0.8692911438831745, 0.8700634221173202, 0.8707126230593977, 0.871235565418655, 0.8716297556068153, 0.8718933993000386, 0.8720254092396389, 0.8720254092396387, 0.871893734389425, 0.8716314274599222, 0.8712402315417902, 0.8707225789640232, 0.870081576560911, 0.8693209873744907, 0.8684452088982887, 0.8674592479862261, 0.8663686925679193, 0.8651796803282145, 0.8638988645244996, 0.862533377130113, 0.8610907895059097, 0.8595790708146857, 0.8580065444046616, 0.8563818423984729, 0.854713858733132, 0.8530117009040974, 0.8512846406729206, 0.8495420640028901, 0.8477934204906377, 0.8460481725637751, 0.8443157447153502, 0.8426054730451366, 0.8409265553756327, 0.8392880022070544, 0.8376985887706458, 0.8361668084333136, 0.8347008276989286, 0.8333084430427204, 0.8319970398050268, 0.830773553359305, 0.8296444327568848, 0.8286156070374121, 0.8276924543794828, 0.8268797742505719, 0.8261817626991929, 0.8256019909152976, 0.8251433871673842, 0.8248082222066738, 0.8245980982101918, 0.824513941315678, 0.8245559977821237, 0.8247238337904391, 0.8250163388794189, 0.8254317329928937, 0.8259675770948395, 0.8266207872903447, 0.8273876523718274, 0.8282638546918534, 0.8292444942463764, 0.8303241158353855, 0.8314967391517764, 0.8327558916339596, 0.8340946439032682, 0.8355056475937643, 0.8369811753696111, 0.8385131629138363, 0.8400932526621451, 0.8417128390464708, 0.8433631150052462, 0.8450351195109564, 0.8467197858604646, 0.8484079904698436, 0.8500906019131113, 0.8517585299432627, 0.853402774234412, 0.8550144725856306, 0.8565849483302359, 0.8581057566987819, 0.8595687298898429, 0.8609660206098184, 0.8622901438513589, 0.863534016689624, 0.8646909958863274, 0.865754913103392, 0.8667201075409176, 0.867581455828035, 0.8683343990099791, 0.868974966490264, 0.8694997968031789, 0.8699061551087427, 0.8701919473197804, 0.8703557307887437, 0.8703967215002415, 0.8703147977338431, 0.8701105001805165, 0.8697850285148903, 0.8693402344443815, 0.8687786112749198, 0.8681032800514752, 0.8673179723497627, 0.8664270098132231, 0.8654352805466233, 0.8643482124942314, 0.86317174394648, 0.8619122913341766, 0.8605767144836601, 0.859172279519674, 0.8577066196151231, 0.8561876937982256, 0.8546237440377582, 0.8530232508361524, 0.8513948875679965, 0.8497474738080663, 0.8480899278982474, 0.8464312190066617, 0.8447803189348959, 0.8431461539304532, 0.841537556761443, 0.8399632193090095, 0.8384316459301823, 0.8369511078396226, 0.8355295987532808, 0.8341747920301619, 0.8328939995403987, 0.8316941324785724, 0.8305816643308437, 0.8295625961929506, 0.8286424246235906, 0.827826112204207, 0.827118060961763, 0.8265220887958539, 0.8260414090355226, 0.8256786132344809, 0.8254356572962144, 0.8253138510027506, 0.8253138510027508, 0.8254356572962145, 0.8256786132344808, 0.8260414090355228, 0.8265220887958535, 0.8271180609617631, 0.8278261122042074, 0.8286424246235905, 0.8295625961929506, 0.8305816643308442, 0.8316941324785724, 0.8328939995403987, 0.8341747920301623, 0.835529598753281, 0.8369511078396229, 0.8384316459301822, 0.8399632193090099, 0.8415375567614429, 0.8431461539304534, 0.844780318934896, 0.8464312190066621, 0.8480899278982476, 0.8497474738080668, 0.8513948875679971, 0.8530232508361527, 0.8546237440377585, 0.8561876937982263, 0.8577066196151236, 0.8591722795196742, 0.8605767144836604, 0.8619122913341766, 0.8631717439464802, 0.8643482124942319, 0.8654352805466234, 0.8664270098132236, 0.8673179723497629, 0.8681032800514755, 0.8687786112749197, 0.8693402344443817, 0.8697850285148905, 0.870110500180517, 0.8703147977338431, 0.8703967215002413, 0.8703557307887441, 0.8701919473197804, 0.8699061551087434, 0.8694997968031789, 0.8689749664902642, 0.8683343990099793, 0.8675814558280354, 0.8667201075409176, 0.8657549131033923, 0.8646909958863279, 0.8635340166896243, 0.8622901438513594, 0.8609660206098187, 0.8595687298898429, 0.8581057566987819, 0.8565849483302366, 0.855014472585631, 0.8534027742344121, 0.851758529943263, 0.8500906019131115, 0.8484079904698439, 0.8467197858604649, 0.8450351195109569, 0.8433631150052462, 0.8417128390464709, 0.8400932526621453, 0.8385131629138365, 0.8369811753696115, 0.8355056475937646, 0.8340946439032682, 0.8327558916339597, 0.8314967391517765, 0.8303241158353856, 0.8292444942463766, 0.8282638546918536, 0.8273876523718278, 0.8266207872903447, 0.8259675770948398, 0.8254317329928936, 0.825016338879419, 0.8247238337904393, 0.8245559977821239, 0.8245139413156782, 0.824598098210192, 0.824808222206674, 0.8251433871673842, 0.8256019909152978, 0.8261817626991931, 0.8268797742505719, 0.8276924543794828, 0.8286156070374124, 0.8296444327568848, 0.8307735533593055, 0.8319970398050269, 0.8333084430427208, 0.8347008276989285, 0.8361668084333139, 0.8376985887706457, 0.8392880022070541, 0.8409265553756328, 0.8426054730451367, 0.8443157447153504, 0.8460481725637752, 0.8477934204906377, 0.8495420640028903, 0.8512846406729204, 0.8530117009040978, 0.8547138587331323, 0.856381842398473, 0.8580065444046618, 0.8595790708146857, 0.8610907895059094, 0.8625333771301135, 0.8638988645244997, 0.8651796803282145, 0.8663686925679193, 0.8674592479862263, 0.8684452088982887, 0.8693209873744904, 0.8700815765609112, 0.8707225789640234, 0.8712402315417903, 0.8716314274599223, 0.8718937343894251, 0.8720254092396389, 0.8720254092396389, 0.8718933993000385, 0.8716297556068151, 0.8712355654186553, 0.8707126230593972, 0.8700634221173205, 0.8692911438831746, 0.8683996420789067, 0.867393423948824, 0.8662776278044456, 0.8650579971333161, 0.8637408514005991, 0.8623330536901226, 0.8608419753487274, 0.859275457814076, 0.8576417718215291, 0.8559495742001035, 0.8542078624808986, 0.8524259275535949, 0.8506133046176185, 0.8487797226843148, 0.846935052894868, 0.8450892559257315, 0.8432523287589628, 0.8414342510990019, 0.8396449317201428, 0.8378941550301338, 0.8361915281350406, 0.8345464286887003, 0.8329679538067718, 0.831464870320603, 0.8300455666398596, 0.8287180064851587, 0.8274896847428508, 0.826367585683628, 0.8253581437748629, 0.8244672073035687, 0.8237000050126766, 0.8230611159379883, 0.8225544426168385, 0.8221831878221724, 0.8219498349575883, 0.8218561322299494, 0.821903080696535, 0.8220909262635401, 0.8224191556920293, 0.8228864966464493, 0.8234909217995181, 0.8242296569858667, 0.8250991933753735, 0.8260953036157385, 0.8272130618726616, 0.8284468676751247, 0.8297904734527913, 0.8312370156326135, 0.8327790491424255, 0.834408585150719, 0.8361171318540639, 0.8378957381068224, 0.839735039672005, 0.8416253078574533, 0.8435565002880131, 0.8455183135521499, 0.8475002374505474, 0.8494916105647164, 0.8514816768555976, 0.8534596429955605, 0.8554147361321828, 0.8573362617787262, 0.8592136615243625, 0.861036570256929, 0.8627948725923515, 0.8644787582078418, 0.8660787757805278, 0.8675858852393488, 0.8689915080457418, 0.8702875752279141, 0.871466572904181, 0.8725215850430381, 0.8734463332211552, 0.8742352131553078, 0.8748833278003636, 0.8753865168226599, 0.8757413822764172, 0.875945310330137, 0.8759964889100919, 0.8758939211489815, 0.8756374345494646, 0.8752276857944683, 0.8746661611588407, 0.8739551724998975, 0.873097848827625, 0.8720981234786033, 0.8709607169410013, 0.8696911154011384, 0.868295545104964, 0.8667809426503151, 0.8651549213477687, 0.8634257338092869, 0.8616022309444552, 0.8596938175639028, 0.8577104048083157, 0.855662359639207, 0.8535604516442333, 0.8514157974252152, 0.8492398028510437, 0.847044103470295, 0.8448405033895146, 0.8426409129327381, 0.8404572854057981, 0.8383015532953221, 0.8361855642369689, 0.8341210170903743, 0.8321193984594477, 0.8301919199960821, 0.8283494568229661, 0.8266024874070754, 0.824961035209539, 0.8234346124299664, 0.8220321661540259, 0.820762027202084, 0.8196318619641542, 0.8186486274922653, 0.8178185301057385, 0.8171469877478436, 0.8166385963139233, 0.8162971001514747, 0.8161253669119088, 0.8161253669119092, 0.8162981571395503, 0.8166438700167747, 0.8171617070055182, 0.8178499371199242, 0.818705900381731, 0.8197260162302515, 0.8209057968724902, 0.8222398655330033, 0.8237219795372125, 0.8253450581362142, 0.8271012149557693, 0.8289817949272639, 0.8309774155341448, 0.8330780121837633, 0.8352728874918377, 0.837550764244991, 0.8398998417861699, 0.8423078555482842, 0.844762139443251, 0.847249690796892, 0.8497572375048933, 0.8522713070713784, 0.8547782971796817, 0.8572645474346585, 0.8597164119074414, 0.8621203321069749, 0.8644629099979858, 0.8667309806823149, 0.8689116843597539, 0.8709925371857551, 0.8729615006465502, 0.8748070490774044, 0.8765182349568605, 0.8780847516189049, 0.8794969930359756, 0.8807461103385692, 0.8818240647518724, 0.8827236766462175, 0.8834386704162518, 0.8839637149233471, 0.8842944592569392, 0.8844275635930361, 0.8843607249519757, 0.8840926976825492, 0.8836233085256727, 0.8829534661378238, 0.8820851649822684, 0.8810214835245822, 0.8797665766979877, 0.8783256626334071, 0.8767050036787425, 0.8749118817616166, 0.8729545681794154, 0.8708422879299088, 0.8685851787247663, 0.866194244856807, 0.863681306119692, 0.8610589420058093, 0.8583404314341883, 0.8555396882852888, 0.8526711930432627, 0.8497499208687137, 0.8467912664458922, 0.84381096596761, 0.8408250166387871, 0.8378495940953614, 0.8349009681492177, 0.8319954172817401, 0.8291491423184755, 0.8263781797251631, 0.8236983149709716, 0.821124996408171, 0.818673250118576, 0.816357596175948, 0.8141919667701205, 0.812189626632878, 0.810363096197642, 0.8087240779147784, 0.8072833861318902, 0.8060508809338498, 0.8050354063205903, 0.8042447330819315, 0.8036855067079594, 0.803363200650903, 0.8032820752300566, 0.8034451424452671, 0.8038541369369012, 0.804509493301193, 0.8054103299395808, 0.806554439589154, 0.8079382866489089, 0.80955701138318, 0.8114044410496217, 0.8134731079646031, 0.8157542744839833, 0.8182379648421643, 0.82091300375723, 0.8237670616750431, 0.8267867064905585, 0.8299574615505101, 0.8332638697081957, 0.8366895631684887, 0.8402173388296311, 0.8438292387979558, 0.8475066357226022, 0.8512303225697149, 0.8549806064296314, 0.858737405926404, 0.8624803517766882, 0.8661888900247969, 0.8698423874625822, 0.8734202387269532, 0.8769019745543024, 0.8802673706600219, 0.8834965567026787, 0.8865701247863973, 0.8894692369515589, 0.8921757311031454, 0.894672224827969, 0.8969422165565908, 0.8989701835330045, 0.9007416760651079, 0.9022434075415404, 0.9034633397156902, 0.904390762775363, 0.9050163697368905, 0.9053323247250312, 0.9053323247250316, 0.9050116544203438, 0.9043672337588244, 0.9033976579214714, 0.9021032294009013, 0.9004859819315915, 0.8985496960502776, 0.896299906102701, 0.8937438985518784, 0.8908907014831308, 0.8877510652420264, 0.8843374341829919, 0.8806639095484435, 0.8767462035406617, 0.8726015846911395, 0.8682488146744917, 0.8637080767561055, 0.859000896104271, 0.8541500522384311, 0.8491794839251168, 0.8441141868720626, 0.8389801046085417, 0.8338040129761202, 0.8286133986884818, 0.8234363324516245, 0.8183013371664026, 0.8132372517638827, 0.808273091250212, 0.8034379035614725, 0.798760623850208, 0.794269926843865, 0.7899940779311204, 0.7859607836449525, 0.7821970422212234, 0.7787289949184265, 0.7755817787880516, 0.7727793815857139, 0.7703444995107274, 0.768298398456186, 0.7666607794428456, 0.7654496488981949, 0.7646811944270944, 0.7643696667022991, 0.764527268082114, 0.7651640485384813, 0.7662878094519492, 0.7679040158004834, 0.7700157172369193, 0.7726234785152153, 0.7757253196887388, 0.7793166664646223, 0.7833903110570755, 0.7879363838394883, 0.7929423360504609, 0.798392933762717, 0.8042702632763784, 0.8105537480495532, 0.8172201772297767, 0.8242437457997951, 0.8315961063006971, 0.8392464320447376, 0.8471614916795074, 0.8553057349147265, 0.8636413891729803, 0.8721285668765009, 0.8807253830337765, 0.8893880827426303, 0.8980711781805797, 0.9067275946090865, 0.9153088248758431, 0.9237650918587658, 0.9320455182570523, 0.9400983030987052, 0.9478709043004626, 0.9553102265853015, 0.9623628140347523, 0.9689750465282606, 0.9750933392999435, 0.9806643448243995, 0.9856351562278166, 0.9899535114086151, 0.9935679970432676, 0.9964282516479034, 0.9984851668647052, 0.9996910861441892, 1, 0.9993677370220273, 0.9977521498462927, 0.9951132952962284, 0.9914136079295768, 0.9866180662480462, 0.9806943508531241, 0.9736129938608121, 0.9653475189204821, 0.9558745712184443, 0.9451740368849283, 0.9332291512639438, 0.920026595548718, 0.9055565813308667, 0.889812922659033, 0.8727930952521767, 0.8544982825638141, 0.8349334084460779, 0.8141071562162852, 0.7920319739835032, 0.7687240661481843, 0.7442033710440504, 0.7184935247477884, 0.691621811138597, 0.6636190983458096, 0.6345197617786843, 0.6043615939875243, 0.5731857016595077, 0.5410363901056446, 0.5079610356469393, 0.4740099463578585, 0.43923621167343596, 0.4036955414125013, 0.367446094813463, 0.3305483002205537, 0.2930646660973405, 0.25505958408039897, 0.21659912481919388, 0.17775082737827969, 0.13858348300479523, 0.09916691408769866, 0.059571749155314005, 0.01986919477425336, -0.01986919477425346, -0.05957174915531411, -0.09916691408769845, -0.1385834830047953, -0.17775082737828016, -0.21659912481919363, -0.25505958408039897, -0.2930646660973406, -0.33054830022055387, -0.36744609481346335, -0.40369554141250125, -0.43923621167343607, -0.47400994635785854, -0.507961035646939, -0.5410363901056445, -0.5731857016595083, -0.6043615939875243, -0.6345197617786839, -0.6636190983458095, -0.6916218111385978, -0.7184935247477889, -0.74420337104405, -0.7687240661481847, -0.7920319739835032, -0.814107156216285, -0.8349334084460781, -0.8544982825638143, -0.8727930952521775, -0.8898129226590327, -0.9055565813308666, -0.9200265955487187, -0.9332291512639439, -0.9451740368849283, -0.9558745712184443, -0.9653475189204817, -0.9736129938608119, -0.9806943508531243, -0.9866180662480454, -0.991413607929577, -0.9951132952962286, -0.9977521498462925, -0.9993677370220283, -0.9999999999999997, -0.999691086144189, -0.9984851668647056, -0.996428251647903, -0.9935679970432674, -0.9899535114086145, -0.9856351562278169, -0.9806643448243998, -0.9750933392999431, -0.9689750465282608, -0.9623628140347524, -0.9553102265853018, -0.947870904300463, -0.9400983030987051, -0.9320455182570516, -0.9237650918587658, -0.9153088248758431, -0.9067275946090867, -0.8980711781805798, -0.88938808274263, -0.8807253830337768, -0.8721285668765006, -0.8636413891729803, -0.8553057349147265, -0.8471614916795073, -0.8392464320447375, -0.8315961063006972, -0.824243745799795, -0.817220177229777, -0.8105537480495529, -0.8042702632763782, -0.7983929337627172, -0.7929423360504609, -0.7879363838394882, -0.7833903110570756, -0.7793166664646222, -0.7757253196887389, -0.7726234785152156, -0.7700157172369191, -0.7679040158004835, -0.766287809451949, -0.7651640485384814, -0.7645272680821142, -0.7643696667022989, -0.7646811944270949, -0.7654496488981951, -0.7666607794428456, -0.7682983984561859, -0.7703444995107271, -0.7727793815857142, -0.7755817787880517, -0.7787289949184267, -0.7821970422212233, -0.7859607836449524, -0.7899940779311203, -0.7942699268438652, -0.7987606238502081, -0.8034379035614722, -0.808273091250212, -0.8132372517638824, -0.8183013371664024, -0.8234363324516246, -0.8286133986884817, -0.8338040129761203, -0.8389801046085416, -0.844114186872063, -0.8491794839251169, -0.8541500522384309, -0.859000896104271, -0.8637080767561053, -0.8682488146744919, -0.8726015846911392, -0.8767462035406617, -0.8806639095484435, -0.8843374341829919, -0.8877510652420263, -0.890890701483131, -0.8937438985518784, -0.8962999061027013, -0.8985496960502773, -0.9004859819315912, -0.9021032294009017, -0.9033976579214714, -0.9043672337588248, -0.9050116544203438, -0.9053323247250316, -0.9053323247250312, -0.9050163697368904, -0.9043907627753635, -0.9034633397156902, -0.9022434075415408, -0.9007416760651076, -0.8989701835330045, -0.8969422165565908, -0.894672224827969, -0.8921757311031455, -0.8894692369515589, -0.8865701247863975, -0.8834965567026783, -0.8802673706600219, -0.8769019745543024, -0.8734202387269532, -0.869842387462582, -0.8661888900247967, -0.8624803517766882, -0.8587374059264041, -0.8549806064296316, -0.8512303225697151, -0.8475066357226024, -0.8438292387979558, -0.8402173388296313, -0.8366895631684885, -0.8332638697081958, -0.8299574615505101, -0.8267867064905583, -0.8237670616750431, -0.82091300375723, -0.8182379648421644, -0.8157542744839834, -0.8134731079646033, -0.8114044410496216, -0.8095570113831804, -0.8079382866489091, -0.806554439589154, -0.8054103299395806, -0.8045094933011935, -0.8038541369369012, -0.8034451424452677, -0.8032820752300566, -0.8033632006509032, -0.8036855067079596, -0.8042447330819315, -0.8050354063205906, -0.8060508809338499, -0.8072833861318905, -0.808724077914778, -0.8103630961976419, -0.8121896266328777, -0.8141919667701207, -0.8163575961759483, -0.8186732501185761, -0.821124996408171, -0.8236983149709713, -0.8263781797251631, -0.8291491423184756, -0.8319954172817399, -0.8349009681492175, -0.8378495940953614, -0.8408250166387868, -0.8438109659676098, -0.846791266445892, -0.849749920868714, -0.8526711930432627, -0.8555396882852888, -0.8583404314341887, -0.8610589420058098, -0.863681306119692, -0.8661942448568067, -0.8685851787247663, -0.8708422879299088, -0.8729545681794152, -0.8749118817616166, -0.8767050036787425, -0.8783256626334071, -0.8797665766979881, -0.8810214835245826, -0.8820851649822682, -0.8829534661378236, -0.8836233085256723, -0.8840926976825492, -0.8843607249519758, -0.8844275635930361, -0.8842944592569396, -0.8839637149233474, -0.8834386704162518, -0.8827236766462175, -0.8818240647518726, -0.8807461103385694, -0.8794969930359754, -0.8780847516189049, -0.8765182349568605, -0.8748070490774048, -0.8729615006465504, -0.8709925371857554, -0.8689116843597539, -0.8667309806823146, -0.8644629099979858, -0.8621203321069749, -0.8597164119074414, -0.8572645474346585, -0.8547782971796817, -0.8522713070713784, -0.8497572375048933, -0.8472496907968923, -0.8447621394432511, -0.8423078555482844, -0.83989984178617, -0.8375507642449911, -0.8352728874918383, -0.8330780121837634, -0.8309774155341445, -0.8289817949272638, -0.8271012149557694, -0.8253450581362143, -0.8237219795372125, -0.8222398655330037, -0.8209057968724903, -0.8197260162302512, -0.818705900381731, -0.8178499371199243, -0.817161707005518, -0.8166438700167747, -0.8162981571395505, -0.816125366911909, -0.8161253669119088, -0.8162971001514748, -0.8166385963139234, -0.8171469877478436, -0.8178185301057385, -0.8186486274922655, -0.8196318619641545, -0.8207620272020839, -0.8220321661540259, -0.8234346124299665, -0.8249610352095391, -0.8266024874070753, -0.8283494568229659, -0.8301919199960821, -0.8321193984594475, -0.8341210170903743, -0.8361855642369689, -0.8383015532953217, -0.8404572854057979, -0.8426409129327382, -0.8448405033895144, -0.847044103470295, -0.849239802851044, -0.8514157974252156, -0.8535604516442331, -0.8556623596392068, -0.8577104048083161, -0.8596938175639028, -0.861602230944455, -0.8634257338092871, -0.8651549213477686, -0.8667809426503151, -0.868295545104964, -0.869691115401138, -0.8709607169410013, -0.872098123478603, -0.8730978488276252, -0.8739551724998973, -0.8746661611588407, -0.8752276857944683, -0.8756374345494649, -0.8758939211489815, -0.8759964889100915, -0.875945310330137, -0.8757413822764172, -0.8753865168226599, -0.8748833278003637, -0.8742352131553075, -0.8734463332211552, -0.872521585043038, -0.8714665729041805, -0.8702875752279143, -0.868991508045742, -0.8675858852393488, -0.8660787757805283, -0.8644787582078416, -0.8627948725923511, -0.8610365702569288, -0.8592136615243627, -0.8573362617787265, -0.8554147361321828, -0.8534596429955605, -0.8514816768555977, -0.8494916105647164, -0.8475002374505474, -0.8455183135521501, -0.8435565002880127, -0.8416253078574532, -0.839735039672005, -0.8378957381068223, -0.8361171318540641, -0.8344085851507188, -0.8327790491424255, -0.8312370156326137, -0.8297904734527913, -0.8284468676751247, -0.8272130618726614, -0.8260953036157387, -0.8250991933753739, -0.8242296569858668, -0.823490921799518, -0.8228864966464491, -0.8224191556920292, -0.8220909262635403, -0.821903080696535, -0.8218561322299494, -0.8219498349575888, -0.8221831878221724, -0.8225544426168383, -0.8230611159379883, -0.8237000050126768, -0.824467207303569, -0.8253581437748629, -0.8263675856836283, -0.8274896847428507, -0.8287180064851585, -0.8300455666398596, -0.8314648703206032, -0.8329679538067718, -0.8345464286887003, -0.8361915281350406, -0.8378941550301335, -0.8396449317201428, -0.8414342510990019, -0.8432523287589628, -0.8450892559257314, -0.8469350528948678, -0.8487797226843148, -0.8506133046176185, -0.8524259275535953, -0.8542078624808989, -0.8559495742001036, -0.8576417718215291, -0.8592754578140758, -0.8608419753487271, -0.8623330536901226, -0.863740851400599, -0.8650579971333161, -0.8662776278044456, -0.8673934239488242, -0.8683996420789063, -0.8692911438831745, -0.8700634221173202, -0.8707126230593977, -0.871235565418655, -0.8716297556068153, -0.8718933993000386, -0.8720254092396389, -0.8720254092396387, -0.871893734389425, -0.8716314274599222, -0.8712402315417902, -0.8707225789640232, -0.870081576560911, -0.8693209873744907, -0.8684452088982887, -0.8674592479862261, -0.8663686925679193, -0.8651796803282145, -0.8638988645244996, -0.862533377130113, -0.8610907895059097, -0.8595790708146857, -0.8580065444046616, -0.8563818423984729, -0.854713858733132, -0.8530117009040974, -0.8512846406729206, -0.8495420640028901, -0.8477934204906377, -0.8460481725637751, -0.8443157447153502, -0.8426054730451366, -0.8409265553756327, -0.8392880022070544, -0.8376985887706458, -0.8361668084333136, -0.8347008276989286, -0.8333084430427204, -0.8319970398050268, -0.830773553359305, -0.8296444327568848, -0.8286156070374121, -0.8276924543794828, -0.8268797742505719, -0.8261817626991929, -0.8256019909152976, -0.8251433871673842, -0.8248082222066738, -0.8245980982101918, -0.824513941315678, -0.8245559977821237, -0.8247238337904391, -0.8250163388794189, -0.8254317329928937, -0.8259675770948395, -0.8266207872903447, -0.8273876523718274, -0.8282638546918534, -0.8292444942463764, -0.8303241158353855, -0.8314967391517764, -0.8327558916339596, -0.8340946439032682, -0.8355056475937643, -0.8369811753696111, -0.8385131629138363, -0.8400932526621451, -0.8417128390464708, -0.8433631150052462, -0.8450351195109564, -0.8467197858604646, -0.8484079904698436, -0.8500906019131113, -0.8517585299432627, -0.853402774234412, -0.8550144725856306, -0.8565849483302359, -0.8581057566987819, -0.8595687298898429, -0.8609660206098184, -0.8622901438513589, -0.863534016689624, -0.8646909958863274, -0.865754913103392, -0.8667201075409176, -0.867581455828035, -0.8683343990099791, -0.868974966490264, -0.8694997968031789, -0.8699061551087427, -0.8701919473197804, -0.8703557307887437, -0.8703967215002415, -0.8703147977338431, -0.8701105001805165, -0.8697850285148903, -0.8693402344443815, -0.8687786112749198, -0.8681032800514752, -0.8673179723497627, -0.8664270098132231, -0.8654352805466233, -0.8643482124942314, -0.86317174394648, -0.8619122913341766, -0.8605767144836601, -0.859172279519674, -0.8577066196151231, -0.8561876937982256, -0.8546237440377582, -0.8530232508361524, -0.8513948875679965, -0.8497474738080663, -0.8480899278982474, -0.8464312190066617, -0.8447803189348959, -0.8431461539304532, -0.841537556761443, -0.8399632193090095, -0.8384316459301823, -0.8369511078396226, -0.8355295987532808, -0.8341747920301619, -0.8328939995403987, -0.8316941324785724, -0.8305816643308437, -0.8295625961929506, -0.8286424246235906, -0.827826112204207, -0.827118060961763, -0.8265220887958539, -0.8260414090355226, -0.8256786132344809, -0.8254356572962144, -0.8253138510027506, -0.8253138510027508, -0.8254356572962145, -0.8256786132344808, -0.8260414090355228, -0.8265220887958535, -0.8271180609617631, -0.8278261122042074, -0.8286424246235905, -0.8295625961929506, -0.8305816643308442, -0.8316941324785724, -0.8328939995403987, -0.8341747920301623, -0.835529598753281, -0.8369511078396229, -0.8384316459301822, -0.8399632193090099, -0.8415375567614429, -0.8431461539304534, -0.844780318934896, -0.8464312190066621, -0.8480899278982476, -0.8497474738080668, -0.8513948875679971, -0.8530232508361527, -0.8546237440377585, -0.8561876937982263, -0.8577066196151236, -0.8591722795196742, -0.8605767144836604, -0.8619122913341766, -0.8631717439464802, -0.8643482124942319, -0.8654352805466234, -0.8664270098132236, -0.8673179723497629, -0.8681032800514755, -0.8687786112749197, -0.8693402344443817, -0.8697850285148905, -0.870110500180517, -0.8703147977338431, -0.8703967215002413, -0.8703557307887441, -0.8701919473197804, -0.8699061551087434, -0.8694997968031789, -0.8689749664902642, -0.8683343990099793, -0.8675814558280354, -0.8667201075409176, -0.8657549131033923, -0.8646909958863279, -0.8635340166896243, -0.8622901438513594, -0.8609660206098187, -0.8595687298898429, -0.8581057566987819, -0.8565849483302366, -0.855014472585631, -0.8534027742344121, -0.851758529943263, -0.8500906019131115, -0.8484079904698439, -0.8467197858604649, -0.8450351195109569, -0.8433631150052462, -0.8417128390464709, -0.8400932526621453, -0.8385131629138365, -0.8369811753696115, -0.8355056475937646, -0.8340946439032682, -0.8327558916339597, -0.8314967391517765, -0.8303241158353856, -0.8292444942463766, -0.8282638546918536, -0.8273876523718278, -0.8266207872903447, -0.8259675770948398, -0.8254317329928936, -0.825016338879419, -0.8247238337904393, -0.8245559977821239, -0.8245139413156782, -0.824598098210192, -0.824808222206674, -0.8251433871673842, -0.8256019909152978, -0.8261817626991931, -0.8268797742505719, -0.8276924543794828, -0.8286156070374124, -0.8296444327568848, -0.8307735533593055, -0.8319970398050269, -0.8333084430427208, -0.8347008276989285, -0.8361668084333139, -0.8376985887706457, -0.8392880022070541, -0.8409265553756328, -0.8426054730451367, -0.8443157447153504, -0.8460481725637752, -0.8477934204906377, -0.8495420640028903, -0.8512846406729204, -0.8530117009040978, -0.8547138587331323, -0.856381842398473, -0.8580065444046618, -0.8595790708146857, -0.8610907895059094, -0.8625333771301135, -0.8638988645244997, -0.8651796803282145, -0.8663686925679193, -0.8674592479862263, -0.8684452088982887, -0.8693209873744904, -0.8700815765609112, -0.8707225789640234, -0.8712402315417903, -0.8716314274599223, -0.8718937343894251, -0.8720254092396389, -0.8720254092396389, -0.8718933993000385, -0.8716297556068151, -0.8712355654186553, -0.8707126230593972, -0.8700634221173205, -0.8692911438831746, -0.8683996420789067, -0.867393423948824, -0.8662776278044456, -0.8650579971333161, -0.8637408514005991, -0.8623330536901226, -0.8608419753487274, -0.859275457814076, -0.8576417718215291, -0.8559495742001035, -0.8542078624808986, -0.8524259275535949, -0.8506133046176185, -0.8487797226843148, -0.846935052894868, -0.8450892559257315, -0.8432523287589628, -0.8414342510990019, -0.8396449317201428, -0.8378941550301338, -0.8361915281350406, -0.8345464286887003, -0.8329679538067718, -0.831464870320603, -0.8300455666398596, -0.8287180064851587, -0.8274896847428508, -0.826367585683628, -0.8253581437748629, -0.8244672073035687, -0.8237000050126766, -0.8230611159379883, -0.8225544426168385, -0.8221831878221724, -0.8219498349575883, -0.8218561322299494, -0.821903080696535, -0.8220909262635401, -0.8224191556920293, -0.8228864966464493, -0.8234909217995181, -0.8242296569858667, -0.8250991933753735, -0.8260953036157385, -0.8272130618726616, -0.8284468676751247, -0.8297904734527913, -0.8312370156326135, -0.8327790491424255, -0.834408585150719, -0.8361171318540639, -0.8378957381068224, -0.839735039672005, -0.8416253078574533, -0.8435565002880131, -0.8455183135521499, -0.8475002374505474, -0.8494916105647164, -0.8514816768555976, -0.8534596429955605, -0.8554147361321828, -0.8573362617787262, -0.8592136615243625, -0.861036570256929, -0.8627948725923515, -0.8644787582078418, -0.8660787757805278, -0.8675858852393488, -0.8689915080457418, -0.8702875752279141, -0.871466572904181, -0.8725215850430381, -0.8734463332211552, -0.8742352131553078, -0.8748833278003636, -0.8753865168226599, -0.8757413822764172, -0.875945310330137, -0.8759964889100919, -0.8758939211489815, -0.8756374345494646, -0.8752276857944683, -0.8746661611588407, -0.8739551724998975, -0.873097848827625, -0.8720981234786033, -0.8709607169410013, -0.8696911154011384, -0.868295545104964, -0.8667809426503151, -0.8651549213477687, -0.8634257338092869, -0.8616022309444552, -0.8596938175639028, -0.8577104048083157, -0.855662359639207, -0.8535604516442333, -0.8514157974252152, -0.8492398028510437, -0.847044103470295, -0.8448405033895146, -0.8426409129327381, -0.8404572854057981, -0.8383015532953221, -0.8361855642369689, -0.8341210170903743, -0.8321193984594477, -0.8301919199960821, -0.8283494568229661, -0.8266024874070754, -0.824961035209539, -0.8234346124299664, -0.8220321661540259, -0.820762027202084, -0.8196318619641542, -0.8186486274922653, -0.8178185301057385, -0.8171469877478436, -0.8166385963139233, -0.8162971001514747, -0.8161253669119088, -0.8161253669119092, -0.8162981571395503, -0.8166438700167747, -0.8171617070055182, -0.8178499371199242, -0.818705900381731, -0.8197260162302515, -0.8209057968724902, -0.8222398655330033, -0.8237219795372125, -0.8253450581362142, -0.8271012149557693, -0.8289817949272639, -0.8309774155341448, -0.8330780121837633, -0.8352728874918377, -0.837550764244991, -0.8398998417861699, -0.8423078555482842, -0.844762139443251, -0.847249690796892, -0.8497572375048933, -0.8522713070713784, -0.8547782971796817, -0.8572645474346585, -0.8597164119074414, -0.8621203321069749, -0.8644629099979858, -0.8667309806823149, -0.8689116843597539, -0.8709925371857551, -0.8729615006465502, -0.8748070490774044, -0.8765182349568605, -0.8780847516189049, -0.8794969930359756, -0.8807461103385692, -0.8818240647518724, -0.8827236766462175, -0.8834386704162518, -0.8839637149233471, -0.8842944592569392, -0.8844275635930361, -0.8843607249519757, -0.8840926976825492, -0.8836233085256727, -0.8829534661378238, -0.8820851649822684, -0.8810214835245822, -0.8797665766979877, -0.8783256626334071, -0.8767050036787425, -0.8749118817616166, -0.8729545681794154, -0.8708422879299088, -0.8685851787247663, -0.866194244856807, -0.863681306119692, -0.8610589420058093, -0.8583404314341883, -0.8555396882852888, -0.8526711930432627, -0.8497499208687137, -0.8467912664458922, -0.84381096596761, -0.8408250166387871, -0.8378495940953614, -0.8349009681492177, -0.8319954172817401, -0.8291491423184755, -0.8263781797251631, -0.8236983149709716, -0.821124996408171, -0.818673250118576, -0.816357596175948, -0.8141919667701205, -0.812189626632878, -0.810363096197642, -0.8087240779147784, -0.8072833861318902, -0.8060508809338498, -0.8050354063205903, -0.8042447330819315, -0.8036855067079594, -0.803363200650903, -0.8032820752300566, -0.8034451424452671, -0.8038541369369012, -0.804509493301193, -0.8054103299395808, -0.806554439589154, -0.8079382866489089, -0.80955701138318, -0.8114044410496217, -0.8134731079646031, -0.8157542744839833, -0.8182379648421643, -0.82091300375723, -0.8237670616750431, -0.8267867064905585, -0.8299574615505101, -0.8332638697081957, -0.8366895631684887, -0.8402173388296311, -0.8438292387979558, -0.8475066357226022, -0.8512303225697149, -0.8549806064296314, -0.858737405926404, -0.8624803517766882, -0.8661888900247969, -0.8698423874625822, -0.8734202387269532, -0.8769019745543024, -0.8802673706600219, -0.8834965567026787, -0.8865701247863973, -0.8894692369515589, -0.8921757311031454, -0.894672224827969, -0.8969422165565908, -0.8989701835330045, -0.9007416760651079, -0.9022434075415404, -0.9034633397156902, -0.904390762775363, -0.9050163697368905, -0.9053323247250312, -0.9053323247250316, -0.9050116544203438, -0.9043672337588244, -0.9033976579214714, -0.9021032294009013, -0.9004859819315915, -0.8985496960502776, -0.896299906102701, -0.8937438985518784, -0.8908907014831308, -0.8877510652420264, -0.8843374341829919, -0.8806639095484435, -0.8767462035406617, -0.8726015846911395, -0.8682488146744917, -0.8637080767561055, -0.859000896104271, -0.8541500522384311, -0.8491794839251168, -0.8441141868720626, -0.8389801046085417, -0.8338040129761202, -0.8286133986884818, -0.8234363324516245, -0.8183013371664026, -0.8132372517638827, -0.808273091250212, -0.8034379035614725, -0.798760623850208, -0.794269926843865, -0.7899940779311204, -0.7859607836449525, -0.7821970422212234, -0.7787289949184265, -0.7755817787880516, -0.7727793815857139, -0.7703444995107274, -0.768298398456186, -0.7666607794428456, -0.7654496488981949, -0.7646811944270944, -0.7643696667022991, -0.764527268082114, -0.7651640485384813, -0.7662878094519492, -0.7679040158004834, -0.7700157172369193, -0.7726234785152153, -0.7757253196887388, -0.7793166664646223, -0.7833903110570755, -0.7879363838394883, -0.7929423360504609, -0.798392933762717, -0.8042702632763784, -0.8105537480495532, -0.8172201772297767, -0.8242437457997951, -0.8315961063006971, -0.8392464320447376, -0.8471614916795074, -0.8553057349147265, -0.8636413891729803, -0.8721285668765009, -0.8807253830337765, -0.8893880827426303, -0.8980711781805797, -0.9067275946090865, -0.9153088248758431, -0.9237650918587658, -0.9320455182570523, -0.9400983030987052, -0.9478709043004626, -0.9553102265853015, -0.9623628140347523, -0.9689750465282606, -0.9750933392999435, -0.9806643448243995, -0.9856351562278166, -0.9899535114086151, -0.9935679970432676, -0.9964282516479034, -0.9984851668647052, -0.9996910861441892, -1, -0.9993677370220273, -0.9977521498462927, -0.9951132952962284, -0.9914136079295768, -0.9866180662480462, -0.9806943508531241, -0.9736129938608121, -0.9653475189204821, -0.9558745712184443, -0.9451740368849283, -0.9332291512639438, -0.920026595548718, -0.9055565813308667, -0.889812922659033, -0.8727930952521767, -0.8544982825638141, -0.8349334084460779, -0.8141071562162852, -0.7920319739835032, -0.7687240661481843, -0.7442033710440504, -0.7184935247477884, -0.691621811138597, -0.6636190983458096, -0.6345197617786843, -0.6043615939875243, -0.5731857016595077, -0.5410363901056446, -0.5079610356469393, -0.4740099463578585, -0.43923621167343596, -0.4036955414125013, -0.367446094813463, -0.3305483002205537, -0.2930646660973405, -0.25505958408039897, -0.21659912481919388, -0.17775082737827969, -0.13858348300479523, -0.09916691408769866, -0.059571749155314005, -0.01986919477425336
// ]);

// const sqpo = {
//     wavetables: [] as Float32Array[],
//     lastSample: 0, // for one-pole low-pass

//     getSample(phase: number, freq: number) {
//         const numTables = this.wavetables.length;
//         if (numTables === 0) return { sample: 0, new_phase: phase };

//         // --- pick which two tables to interpolate ---
//         // assume table 0 = fewest harmonics, last table = most harmonics
//         // linearly map frequency (or harmonics) to table index
//         const tableIndexF = ((freq / 440) * (numTables - 1)) | 0; // rough heuristic
//         const t0 = Math.floor(tableIndexF);
//         const t1 = Math.min(t0 + 1, numTables - 1);
//         const mix = tableIndexF - t0; // how far between the two tables

//         const table0 = this.wavetables[t0];
//         const table1 = this.wavetables[t1];
//         const len = table0.length;

//         // --- convert normalized phase to table index ---
//         let tablePhase = phase * len;
//         tablePhase += (freq / 44100) * len;
//         tablePhase %= len;

//         const i1 = Math.floor(tablePhase);
//         const frac = tablePhase - i1;

//         const i0 = (i1 - 1 + len) % len;
//         const i2 = i1;
//         const i3 = (i1 + 1) % len;
//         const i4 = (i1 + 2) % len;

//         // cubic Hermite interpolation helper
//         const hermite = (table: Float32Array) => {
//             const y0 = table[i0], y1 = table[i2], y2 = table[i3], y3 = table[i4];
//             const c0 = y1;
//             const c1 = 0.5 * (y2 - y0);
//             const c2 = y0 - 2.5 * y1 + 2 * y2 - 0.5 * y3;
//             const c3 = -0.5 * y0 + 1.5 * y1 - 1.5 * y2 + 0.5 * y3;
//             return ((c3 * frac + c2) * frac + c1) * frac + c0;
//         };

//         // --- interpolate between the two tables ---
//         const sample0 = hermite(table0);
//         const sample1 = hermite(table1);
//         const sampleRaw = sample0 * (1 - mix) + sample1 * mix;

//         // --- band-limit with one-pole low-pass ---
//         const nyquist = 44100 / 2;
//         const cutoff = Math.min(freq * 20, nyquist);
//         const alpha = cutoff / nyquist;
//         const sample = alpha * sampleRaw + (1 - alpha) * this.lastSample;
//         this.lastSample = sample;

//         return { sample, new_phase: tablePhase / len };
//     }
// };


let pickedt: number[] = [];

// const sqpo = {
//     wavetables: {} as Record<number, Float32Array>,
//     lastSample: 0,

//     getSample(phase: number, freq: number) {
//         const midiNote = Math.round(69 + 12 * Math.log2(freq / 440));

//         // pick the closest wavetable frequency from the keys
//         const tableFreqs = Object.keys(this.wavetables).map(Number);
//         let closestFreq = tableFreqs[0];
//         for (let i = 1; i < tableFreqs.length; i++) {
//             if (Math.abs(tableFreqs[i] - freq) < Math.abs(closestFreq - freq)) {
//                 closestFreq = tableFreqs[i];
//             } else {
//                 break; // sorted-ish array assumption
//             }
//         }

//         const table = this.wavetables[closestFreq];
//         const len = table.length;
//         if (!len) return { sample: 0, new_phase: phase };

//         // advance phase
//         phase += freq / 44100;
//         if (phase >= 1) phase -= 1;

//         // cubic interpolation
//         const index = phase * len;
//         const i1 = Math.floor(index);
//         const frac = index - i1;

//         // wrap indices for cubic
//         const i0 = (i1 - 1 + len) % len;
//         const i2 = i1;
//         const i3 = (i1 + 1) % len;
//         const i4 = (i1 + 2) % len;

//         const y0 = table[i0];
//         const y1 = table[i2];
//         const y2 = table[i3];
//         const y3 = table[i4];

//         const c0 = y1;
//         const c1 = 0.5 * (y2 - y0);
//         const c2 = y0 - 2.5 * y1 + 2 * y2 - 0.5 * y3;
//         const c3 = -0.5 * y0 + 1.5 * y1 - 1.5 * y2 + 0.5 * y3;

//         const sample = ((c3 * frac + c2) * frac + c1) * frac + c0;

//         return { sample, new_phase: phase };
//     }
// };

// const sqpo = {
//     wavetables: {} as Record<number, Float32Array>,
//     lastSample: 0,

//     getSample(phase: number, freq: number) {
//         const midiNote = Math.round(69 + 12 * Math.log2(freq / 440));

//         // pick the closest wavetable frequency from the keys
//         const tableFreqs = Object.keys(this.wavetables).map(Number);
//         let closestFreq = tableFreqs[0];
//         for (let i = 1; i < tableFreqs.length; i++) {
//             if (Math.abs(tableFreqs[i] - freq) < Math.abs(closestFreq - freq)) {
//                 closestFreq = tableFreqs[i];
//             } else {
//                 break; // sorted-ish array assumption
//             }
//         }

//         const table = this.wavetables[closestFreq];
//         const len = table.length;
//         if (!len) return { sample: 0, new_phase: phase };

//         // advance phase
//         phase += freq / 44100;
//         if (phase >= 1) phase -= 1;

//         // cubic interpolation
//         const index = phase * len;
//         const i1 = Math.floor(index);
//         const frac = index - i1;

//         // wrap indices for cubic
//         const i0 = (i1 - 1 + len) % len;
//         const i2 = i1;
//         const i3 = (i1 + 1) % len;
//         const i4 = (i1 + 2) % len;

//         const y0 = table[i0];
//         const y1 = table[i2];
//         const y2 = table[i3];
//         const y3 = table[i4];

//         const c0 = y1;
//         const c1 = 0.5 * (y2 - y0);
//         const c2 = y0 - 2.5 * y1 + 2 * y2 - 0.5 * y3;
//         const c3 = -0.5 * y0 + 1.5 * y1 - 1.5 * y2 + 0.5 * y3;

//         const sample = ((c3 * frac + c2) * frac + c1) * frac + c0;

//         return { sample, new_phase: phase };
//     }
// };


// const fft = new webfft(1024);
// const sqpo = {
//     wavetables: {} as Record<number, Float32Array>,
//     lastSample: 0,

//     getSample(phase: number, freq: number) { // fft passed in
//         const fs = 44100;
//         const nyquist = fs / 2;

//         // pick closest wavetable
//         const tableFreqs = Object.keys(this.wavetables).map(Number);
//         let closestFreq = tableFreqs[0];
//         for (let i = 1; i < tableFreqs.length; i++) {
//             if (Math.abs(tableFreqs[i] - freq) < Math.abs(closestFreq - freq)) {
//                 closestFreq = tableFreqs[i];
//             } else break;
//         }

//         const baseTable = this.wavetables[closestFreq];
//         const len = baseTable.length;
//         if (!len) return { sample: 0, new_phase: phase };

//         // ---- live anti-aliasing ----
//         const maxHarmonic = Math.floor(nyquist / freq);
//         const spectrum = fft.fft(baseTable); // returns interleaved complex array [re, im, re, im...]

//         const nBins = len / 2;
//         for (let k = 0; k <= nBins; k++) {
//             const harmonicFreq = k * closestFreq;
//             if (harmonicFreq > nyquist || k > maxHarmonic) {
//                 spectrum[2 * k] = 0;
//                 spectrum[2 * k + 1] = 0;
//                 if (k !== 0) {
//                     const mirror = len - k;
//                     spectrum[2 * mirror] = 0;
//                     spectrum[2 * mirror + 1] = 0;
//                 }
//             }
//         }

//         const aliasedTable = ifft(spectrum, fft, len); // temporary anti-aliased table

//         // advance phase
//         phase += freq / fs;
//         if (phase >= 1) phase -= 1;

//         // cubic interpolation
//         const index = phase * len;
//         const i1 = Math.floor(index);
//         const frac = index - i1;
//         const i0 = (i1 - 1 + len) % len;
//         const i2 = i1;
//         const i3 = (i1 + 1) % len;
//         const i4 = (i1 + 2) % len;

//         const y0 = aliasedTable[i0];
//         const y1 = aliasedTable[i2];
//         const y2 = aliasedTable[i3];
//         const y3 = aliasedTable[i4];

//         const c0 = y1;
//         const c1 = 0.5 * (y2 - y0);
//         const c2 = y0 - 2.5 * y1 + 2 * y2 - 0.5 * y3;
//         const c3 = -0.5 * y0 + 1.5 * y1 - 1.5 * y2 + 0.5 * y3;

//         const sample = ((c3 * frac + c2) * frac + c1) * frac + c0;

//         return { sample, new_phase: phase };
//     }
// };





export class Square implements AudioOutputPlugin {
    wantsMic: boolean;
    pluginName: string;
    type: AOPluginType;
    effects: EffectPlugin[];
    parameters: Record<string, any>;

    //user defined
    object_allocator: UseList_Heap;
    objects: Record<string, Uint8Array & { ptr: number }>;
    midiClips: MidiClip[];
    voiceLookup: Record<number, LiveStruct>;
    flatNotes: LiveStruct[];
    oscillators: any[];
    dv_lanes: Record<number, number>;

    constructor(wavetables: Record<number, Float32Array>) {
        this.wantsMic = false;
        this.pluginName = "2hp";
        this.type = AOPluginType.JS;
        this.effects = [];
        this.object_allocator = new UseList_Heap(1024 * 1024 * 12); //12 mb mem
        this.objects = {};
        this.parameters = {};
        this.midiClips = [];
        this.voiceLookup = {};
        this.flatNotes = [];
        // sqpo.wavetables = wavetables
        this.oscillators = [sqpo];
        this.dv_lanes = {};
    }

    note_processed(lane: number, inst: number): boolean {
        if (typeof this.dv_lanes[lane] == "undefined") {
            this.dv_lanes[lane] = 0
            return false;
        }

        return inst <= this.dv_lanes[lane];
    }

    createObject(name: string, bytes: number): Uint8Array & { ptr: number } {
        const region = this.object_allocator.malloc(bytes);
        this.objects[name] = region;
        return region
    }

    computeFlatNotes(): void {
        this.flatNotes = this.midiClips.flatMap(c => c.notes);
    }

    addMidiClip(c: MidiClip): void {
        this.midiClips.push(c);
        this.computeFlatNotes();
    }
    /**
     * 
     * @param name the regions name
     * @param u8a  u8a must be the same length as the original buf
     */
    setObject(name: string, u8a: Uint8Array) {
        this.objects[name].set(u8a, 0)
    }

    accessObject(name: string) {
        return this.objects[name]
    }

    freeObject(name: string) {
        this.object_allocator.free(this.objects[name])
        return delete this.objects[name]
    }

    /**
     * Fill arr with 128 samples starting at the given absolute sample index
     */
    _process128(arr: Float32Array, startSample: number): void {
        // --- Update voices from MIDI notes ---
        for (let i = 0; i < this.flatNotes.length; i++) {
            const note = this.flatNotes[i];
            if (startSample >= note.startTime) {
                if (note.setsOn && !this.note_processed(note.lane, note.instance)) {
                    this.voiceLookup[note.instance] = this.object_allocator.new(Voice, {
                        pitch: note.pitch,
                        freq: 440 * 2 ** ((note.pitch - 69) / 12),
                        velocity: note.velocity,
                        startTime: note.startTime,
                        done: 0,
                        instance: note.instance,
                        phase: 0,
                        oscillatorPtr: 0,
                    });
                    this.dv_lanes[note.lane] = note.instance;
                    console.log('made voice');
                } else if (!note.setsOn) {
                    const v = this.voiceLookup[note.target];
                    if (v) {
                        v.freq = 0;
                        v.destroy();
                        delete this.voiceLookup[note.target];
                    }
                }
            }
        }

        for (let i = 0; i < 128; i++) {
            let sum = 0;

            for (const _v of Object.values(this.voiceLookup)) {
                const v = _v as any as _VoiceInterface;

                const { sample, new_phase } =
                    this.oscillators[v.oscillatorPtr].getSample(v.phase, v.freq);

                v.phase = new_phase;

                sum += (sample * v.velocity) / 127;
            }

            arr[i] = sum; // <<--- write the mixed sample to the output buffer
        }


    }



    process128(arr: Float32Array, startSample: number): void {
        this._process128(arr, startSample);
        for (let i = 0; i < this.effects.length; i++) {
            this.effects[i].process128(arr, startSample);
        }
    }
    addEffect(e: EffectPlugin): void {
        e.instance = crypto.randomUUID();
        this.effects.push(e);
    }
    removeEffect(e: EffectPlugin): void {
        this.effects = this.effects.filter(ef => ef.instance != e.instance)
    }

    enableEffect(e: EffectPlugin): void {
        const te = this.effects.find(ef => ef.instance == e.instance);
        if (!te) throw new Error("effect not found");
        te.active = true;
    }

    disableEffect(e: EffectPlugin): void {
        const te = this.effects.find(ef => ef.instance == e.instance);
        if (!te) throw new Error("effect not found");
        te.active = false;
    }

    setParameter(p: string, v: any): void {
        this.parameters[p] = v;
    }
}
